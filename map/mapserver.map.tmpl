MAP
  NAME "ASB_SPT"

  UNITS DD

  SIZE 800 600

  IMAGETYPE PNG24

  PROJECTION
    "init=epsg:4326"
  END

  WEB
    METADATA
      ows_title "AusSeabed Survey Planning Tool"
      ows_enable_request "*"
      ows_srs "EPSG:4326 EPSG:25832 EPSG:25833 EPSG:3857"
      wms_feature_info_mime_type "application/json, application/geojson"
      wms_include_items "all"
      wms_enable_request "*"
    END
  END

  OUTPUTFORMAT
    NAME "application/geojson"
    DRIVER 'template'
    MIMETYPE "application/json; subtype=geojson"
    FORMATOPTION 'FILE=geojsontemplate.js'
  END


  OUTPUTFORMAT
    NAME "json"
    DRIVER 'template'
    MIMETYPE "application/json; subtype=geojson"
    FORMATOPTION 'FILE=geojsontemplate.js'
  END

  LAYER
    NAME "upcoming_surveys (beta)"
    METADATA
      "wfs_title"         "Survey Plans" ##REQUIRED
      "wfs_srs"           "EPSG:4326" ## REQUIRED
      "gml_include_items" "all" ## Optional (serves all attributes for layer)
      "gml_featureid"     "id" ## REQUIRED
      "wfs_enable_request" "*"
      wms_enable_request "*"
      "ows_enable_request" "*"
      wms_getfeature_formatlist "application/json, application/geojson"
    END
    STATUS ON
    TEMPLATE "jsontemplate.js"
    TYPE POLYGON
    CONNECTIONTYPE postgis

    CONNECTION "user={{ getenv "POSTGRES_USER" }} password={{ getenv "POSTGRES_PASSWORD" }} dbname={{ getenv "POSTGRES_DATABASE" }} host={{ getenv "POSTGRES_HOSTNAME" }} port={{ getenv "POSTGRES_PORT" }}"
    DATA "area_of_interest from (
            select sp.id as spid, commorgs.orgname as \"commissioningOrganisations\", custmerge.custname as \"custodianOrganisations\" ,sp.status, sp.\"startDate\", sp.\"endDate\", sp.\"contactPerson\", sp.email as \"contactEmail\" ,sp.area_of_interest as area_of_interest, sp.\"surveyName\", sa.group as category, sa.name as purpose
            from survey_plan sp
            join survey_application sa on sp.\"surveyApplicationId\" = sa.id
            full outer join (
              SELECT survey_plan.id as id, string_agg(DISTINCT organisation.name, ', ') as orgname FROM survey_plan LEFT JOIN survey_plan_organisations_organisation ON survey_plan.id = survey_plan_organisations_organisation.\"surveyPlanId\" INNER JOIN organisation ON survey_plan_organisations_organisation.\"organisationId\" = organisation.id GROUP BY survey_plan.id
            ) commorgs on commorgs.id = sp.id
            full outer join (
              SELECT survey_plan.id as id, string_agg(DISTINCT custodian.name, ', ') as custname FROM survey_plan LEFT JOIN survey_plan_custodians_custodian ON survey_plan.id = survey_plan_custodians_custodian.\"surveyPlanId\" INNER JOIN custodian ON survey_plan_custodians_custodian.\"custodianId\" = custodian.id GROUP BY survey_plan.id
            ) custmerge on custmerge.id = sp.id
          ) as subquery using unique spid"
    CLASS
      STYLE
        OUTLINECOLOR "#FFFB0D"
        WIDTH 2
      END
      STYLE
        COLOR "#FFFB0D"
        OPACITY 30
      END
    END
  END

END
